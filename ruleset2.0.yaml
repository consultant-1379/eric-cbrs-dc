modelVersion: 2.0

description: "CBRS Standalone Domain Proxy Service "

# See image catalog: https://confluence.lmera.ericsson.se/display/ACD/ADP+CICD+Docker+Image+Catalog
docker-images:
  - adp-helm-dr-check: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/common-library-adp-helm-dr-check:latest
  - image-dr-check: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/adp-image-dr-check:latest
  - adp-helm-kubectl: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/bob-py3kubehelmbuilder:latest
  - adp-release-auto: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/bob-adp-release-auto:latest
  - grype-scan: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-image-scanning-grype:latest
  - trivy-inline-scan: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/trivy-inline-scan:latest
  - va-scan-kubeaudit: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-scan-kubeaudit:latest
  - va-scan-kubesec: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-scan-kubesec:latest
  - va-scan-kubehunter: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-scan-kubehunter:latest
  - hadolint-scan: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/hadolint-scan:latest
  - doc-builder: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/bob-docbuilder:latest
  - va-scan-kubebench: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-scan-kubebench:latest
  - adp-ciscat-scanner: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-image-scan-ciscat-assessor:latest

import:
  common: common-properties.yaml

# List of constants
properties:
  - image-registry-path: armdocker.rnd.ericsson.se/proj-eric-cbrs-dc
  - image-secret: armdocker
  - image-dev-repopath: ${image-registry-path}-dev
  - image-ci-repopath: ${image-registry-path}-ci-internal
  - image-drop-repopath: ${image-registry-path}-drop
  - image-full-name: ${image-drop-repopath}/${common.docker-image-name}
  - init-image-full-name: ${image-drop-repopath}/${common.init-docker-image-name}
  - image-to-scan: ${image-ci-repopath}/${common.docker-image-name}:${var.version}
  - anchore-grype-image: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/va-image-scanning-grype:latest
  - trivy-image: armdocker.rnd.ericsson.se/proj-adp-cicd-drop/trivy-inline-scan:latest

  # Helm Chart name must follow the pattern: eric-[a-z0-9]{1,5}-[a-z0-9-]{1,30}
  - helm-chart-repo-server-path: https://arm.seli.gic.ericsson.se/artifactory/proj-eric-cbrs-dc
  - helm-chart-dev-repopath: ${helm-chart-repo-server-path}-dev-helm
  - helm-chart-ci-repopath: ${helm-chart-repo-server-path}-ci-internal-helm
  - helm-chart-drop-repo: ${helm-chart-repo-server-path}-drop-helm
  - helm-chart-released-repo: ${helm-chart-repo-server-path}-released-helm

  # ENM CI Portal properties
  - enm-ci-portal-url: https://ci-portal.seli.wh.rnd.internal.ericsson.com
  - enm-ci-portal-repos-url: ${enm-ci-portal-url}/static/staticRepos

  # Functional ID for your Team or CI group to push to Gerrit repo
  - git-user: CBRSCIADM
  - git-repo-path: OSS/ENM-Parent/SQ-Gate/com.ericsson.oss.services.domainproxy/eric-cbrs-dc
  - git-repo-url: https://${git-user}@gerrit-gamma.gic.ericsson.se/a/${git-repo-path}

  - helm-test-values: "networkPolicy.sasPort=5000,DCM_HOST=141.137.239.136,CBRS_LOAD_BALANCER.loadBalancerIP=10.42.14.167"
  - helm-design-rules-extra-values: "-DhelmDesignRule.setValue.eric-cbrs-dc=${helm-test-values}"
  - helm-chart-released-folder: 'build/released-charts'
  - image-drop-repopath-pointfix: proj-eric-cbrs-dc-drop
  - docker-image-pointfix-release-repo: proj-eric-cbrs-dc-released

  - enabled-helm-design-rules: "-DhelmDesignRule.config.DR-D1123-125=skip -DhelmDesignRule.config.DR-D1123-114=skip -DhelmDesignRule.config.DR-D1123-121=skip -DhelmDesignRule.config.DR-D1120-061=skip"
  - enabled-image-design-rules: ""
  - enabled-init-image-design-rules: ""
  - snapshot-version-image-design-rules: "-DimageDesignRule.config.DR-D470203-041=skip -DimageDesignRule.config.DR-D470203-050=skip"

  # PDF Report Properties
  - build-dir: ${env.PWD}
  - config-file: marketplace-config.yaml
  - html-output: html
  - pdf-output: pdf

  - ciscat-test-target-image-name: cis-cat-pro-assessor-test-target-image
  - cbo-hardening-script-archive: common-base-os-hardening-cxa301047-${common.image-base-os-version}.tar.gz
  - cbo-hardening-script-url: https://arm.sero.gic.ericsson.se/artifactory/proj-ldc-repo-rpm-local/common_base_os/hardening/

# Import environment variables (For example: Jenkins parameters)
env:
  - HOME
  - VA_HOME
  - PWD
  - RELEASE (default=false)
  - DOCKER_NETWORK (default=--network host)
  - ENM_DROP
  - ENM_ISO_VERSION

  # Common Base OS
  - IMAGE_REPO
  - IMAGE_TAG
  - PACKAGE_REPO_URL

  # Kubernetes
  - COLLECT_LOGS_DIR (default=./k8s-logs)
  - ENABLE_HELM_V3 (default=true)
  - HELM_INSTALL_TIMEOUT (default=10m)
  - HELM_RELEASE (default=${common.helm-chart-name}-release)
  - HELM_TEST_TIMEOUT (default=5m0s)
  - HELM_VERSION
  - K8_NAMESPACE (default=${common.helm-chart-name}-${var.commithash})
  - KUBECONFIG (default=${env.HOME}/.kube/config)
  - SITE_VALUES
  - BRANCH
  - STD_TIMEOUT (default=120)

  # Credentials
  - DOCKER_CONFIG (default=${env.PWD}/.docker)
  - GERRIT_USERNAME
  - GERRIT_PASSWORD
  - HELM_REPO_TOKEN
    # the ARM functional user name for Helm repository
  - HELM_USER
  - SERO_USER
  - SERO_PASSWORD

  # X-Ray
  - XRAY_USER
  - XRAY_TOKEN

# Variables, set by below tasks
var:
  - commithash
  - commithash-full
  - commit-author
  - commit-email
  - docker-config-basepath
  - image-registry
  - helm-chart-repo-internal
  - image-full-name-internal
  - init-image-full-name-internal
  - image-repopath-internal
  - image-repopath-drop
  - rstate
  - timestamp
  - version
  - snapshot-image-dr
  - enm-iso-repo-url
  # Common Base OS
  - cbo-image-repo
  - cbo-image-tag
  - cbo-package-repo-url
  - docker-sock-group
  - released-version
  - drop-version
  - iso-version
  - temp

default-rules:
  - clean
  - init-dev
  - lint
  - image
  - image-dr-check
  - package
  # - k8s-test

# Rules to execute
rules:
  conditions:
   - task: is-new-iso-available
     cmd: if [[ "${common.enm-iso-repo-url}" =~ "${var.iso-version}" ]]; then false; else true; fi

  # Integrated rule to execute everything locally (init-dev)
  release:
    - rule: clean
    - rule: init-dev
    - rule: lint
    - rule: image
    - rule: image-dr-check
    - rule: package
    - rule: k8s-test

  # Clean workspace
  clean:
    - task: rm
      cmd:
        - rm -rf .bob/ \?/ test-output/
        - rm -rf k8s-logs/
        - rm -f artifact.properties

  # Common tasks for all init rules
  init-common:
    - task: timestamp
      docker-image: adp-release-auto
      cmd: date --rfc-3339=seconds | sed 's/ /T/' > .bob/var.timestamp
    - task: version
      docker-image: adp-release-auto
      docker-flags:
        - "--env RELEASE"
      cmd: generate-version --is-release ${env.RELEASE} --output version
    - task: rstate
      docker-image: adp-release-auto
      cmd: get_rstate.py ${var.version} > .bob/var.rstate
    - task: commit
      docker-image: adp-release-auto
      cmd:
        - git rev-parse --short HEAD > .bob/var.commithash
        - git rev-parse HEAD > .bob/var.commithash-full
        - git log -1 --format='%aN' > .bob/var.commit-author
        - git log -1 --format='%aE' > .bob/var.commit-email

  # Dev Tasks: only used by manually publishing development/black builds by developers
  init-dev:
    - rule: init-common
    - task: image-repopath-internal
      cmd: echo "${image-dev-repopath}" | cut -f2- -d '/' > .bob/var.image-repopath-internal
    - task: image-registry
      cmd: echo "${image-dev-repopath}" | cut -f1 -d '/' > .bob/var.image-registry
    - task: image-full-name-internal
      cmd: echo "${image-dev-repopath}/${common.docker-image-name}" > .bob/var.image-full-name-internal
    - task: init-image-full-name-internal
      cmd: echo "${image-dev-repopath}/${common.init-docker-image-name}" > .bob/var.init-image-full-name-internal
    - task: helm-chart-repo-internal
      cmd: echo "${helm-chart-dev-repopath}" > .bob/var.helm-chart-repo-internal
    - task: set-snapshot-image-dr
      cmd: echo "${snapshot-version-image-design-rules}" > .bob/var.snapshot-image-dr

  # CI-Internal Tasks: used by CI to use as temporary storage for testing, only CI user has write access.
  init-precodereview:
    - rule: init-common
    - task: image-repopath-internal
      cmd: echo "${image-ci-repopath}" | cut -f2- -d '/' > .bob/var.image-repopath-internal
    - task: image-registry
      cmd: echo "${image-ci-repopath}" | cut -f1 -d '/' > .bob/var.image-registry
    - task: image-full-name-internal
      cmd: echo "${image-ci-repopath}/${common.docker-image-name}" > .bob/var.image-full-name-internal
    - task: init-image-full-name-internal
      cmd: echo "${image-ci-repopath}/${common.init-docker-image-name}" > .bob/var.init-image-full-name-internal
    - task: helm-chart-repo-internal
      cmd: echo "${helm-chart-ci-repopath}" > .bob/var.helm-chart-repo-internal
    - task: set-snapshot-image-dr
      cmd: echo "${snapshot-version-image-design-rules}" > .bob/var.snapshot-image-dr

  # Drop level tasks: used by CI to publish artifacts after successful CI pipeline execution for a drop build
  init-drop:
    - rule: init-common
    - task: image-repopath-internal
      cmd: echo "${image-ci-repopath}" | cut -f2- -d '/' > .bob/var.image-repopath-internal
    - task: image-repopath-drop
      cmd: echo "${image-drop-repopath}" | cut -f2- -d '/' > .bob/var.image-repopath-drop
    - task: image-registry
      cmd: echo "${image-ci-repopath}" | cut -f1 -d '/' > .bob/var.image-registry
    - task: image-full-name-internal
      cmd: echo "${image-ci-repopath}/${common.docker-image-name}" > .bob/var.image-full-name-internal
    - task: init-image-full-name-internal
      cmd: echo "${image-ci-repopath}/${common.init-docker-image-name}" > .bob/var.init-image-full-name-internal
    - task: helm-chart-repo-internal
      cmd: echo "${helm-chart-ci-repopath}" > .bob/var.helm-chart-repo-internal
    - task: adp-artifacts-properties
      docker-image: adp-release-auto
      cmd: generate-adp-artifacts
        --chart-name ${common.helm-chart-name}
        --chart-version ${var.version}
        --chart-repo ${helm-chart-drop-repo}
        --image-name ${common.docker-image-name}
        --image-version ${var.version}
        --image-repo "${var.image-registry}/${var.image-repopath-drop}"
    - task: write-git-details
      cmd:
        - echo "GIT_TAG=$(git log -1 --pretty=format:'%h')" >> artifact.properties
        - echo "GIT_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> artifact.properties
        - echo "GIT_COMMIT_SUMMARY=$(git log -1 --pretty=format:'%s')" >> artifact.properties
    - task: unset-snapshot-image-dr
      cmd: echo "" > .bob/var.snapshot-image-dr

  init-updatecbo:
    - task: replace-quotes
      cmd:
        - echo ${env.IMAGE_REPO} | sed -e 's/^"//' -e 's/"$//' > .bob/var.cbo-image-repo
        - echo ${env.IMAGE_TAG} | sed -e 's/^"//' -e 's/"$//' > .bob/var.cbo-image-tag
        - echo ${env.PACKAGE_REPO_URL} | sed -e 's/^"//' -e 's/"$//' > .bob/var.cbo-package-repo-url

  lint:
    - task: create_dir
      cmd:
        - mkdir -p ${env.PWD}/Design_Rules
        - mkdir -p ${env.PWD}/Vulnerability_Report
        - mkdir -p ${env.PWD}/Vulnerability_Report/${html-output}
        - mkdir -p ${env.PWD}/Vulnerability_Report/${pdf-output}
    - task: helm
      docker-image: adp-helm-dr-check
      docker-flags:
        - "--env ENABLE_HELM_V3=true"
        - ${env.DOCKER_NETWORK}
      cmd: helm3 lint charts/${common.helm-chart-name} --set ${helm-test-values}
    - task: helm-chart-check
      docker-image: adp-helm-dr-check
      cmd: helm-dr-check --helm-v3 --output ${env.PWD}/Design_Rules --helm-chart charts/${common.helm-chart-name} ${enabled-helm-design-rules} ${helm-design-rules-extra-values}

  # Build a docker image pointing to dirty repository
  image:
    - task: download-cbo-hardening-script
      docker-image: adp-release-auto
      cmd:
        - arm download-artifact --url ${cbo-hardening-script-url}${common.image-base-os-version}/${cbo-hardening-script-archive} --apikey ${env.SERO_PASSWORD}
        - mkdir -p ${env.PWD}/docker/${common.docker-image-name}/cbo-hardening
        - mkdir -p ${env.PWD}/docker/${common.init-docker-image-name}/cbo-hardening
        - tar -C ${env.PWD}/docker/${common.docker-image-name}/cbo-hardening/ -xf ${cbo-hardening-script-archive}
        - rm ${cbo-hardening-script-archive}
        - chmod +x ${env.PWD}/docker/${common.docker-image-name}/cbo-hardening/cbo-harden.sh
        - cp -r ${env.PWD}/docker/${common.docker-image-name}/cbo-hardening/cbo-harden.sh ${env.PWD}/docker/${common.init-docker-image-name}/cbo-hardening/cbo-harden.sh
    - task: docker-build
      cmd: docker build ${env.PWD}/docker/${common.docker-image-name} ${env.DOCKER_NETWORK}
        --tag ${var.image-full-name-internal}:${var.version}
        --build-arg OS_BASE_IMAGE_REPO=${common.image-base-os-repo}
        --build-arg OS_BASE_IMAGE_TAG=${common.image-base-os-version}
        --build-arg COMMIT=${var.commithash}
        --build-arg RSTATE=${var.rstate}
        --build-arg TIMESTAMP=${var.timestamp}
        --build-arg VERSION=${var.version}
        --build-arg PACKAGE_REPO_URL=${common.cbo-package-repo-url}
        --build-arg ENM_ISO_REPO_URL=${common.enm-iso-repo-url}
    - task: docker-build-init
      cmd: docker build ${env.PWD}/docker/${common.init-docker-image-name} ${env.DOCKER_NETWORK}
        --tag ${var.init-image-full-name-internal}:${var.version}
        --build-arg OS_BASE_IMAGE_REPO=${common.image-base-os-repo}
        --build-arg OS_BASE_IMAGE_TAG=${common.image-base-os-version}
        --build-arg COMMIT=${var.commithash}
        --build-arg RSTATE=${var.rstate}
        --build-arg TIMESTAMP=${var.timestamp}
        --build-arg VERSION=${var.version}
        --build-arg PACKAGE_REPO_URL=${common.cbo-package-repo-url}
        --build-arg ENM_ISO_REPO_URL=${common.enm-iso-repo-url}

  # Check for image design rule compliance
  image-dr-check:
    - task: check-image-dr
      docker-image: image-dr-check
      docker-in-docker: socket
      cmd: "image-dr-check
          --image ${var.image-full-name-internal}:${var.version}
          --output ${env.PWD}/Design_Rules/check-image/
          ${var.snapshot-image-dr}
          ${enabled-image-design-rules}
          ${helm-design-rules-extra-values}"
    - task: check-init-image-dr
      docker-image: image-dr-check
      docker-in-docker: socket
      cmd: "image-dr-check
          --image ${var.init-image-full-name-internal}:${var.version}
          --output ${env.PWD}/Design_Rules/check-init-image/
          ${var.snapshot-image-dr}
          ${enabled-init-image-design-rules}"

  # Push image to ci-internal repo and create local version of helm chart
  package-local:
    - task: image-push-internal
      cmd:
      - docker push ${var.image-full-name-internal}:${var.version}
      - docker push ${var.init-image-full-name-internal}:${var.version}
    - task: package-helm-internal
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env ENABLE_HELM_V3=true"
      cmd: helm-package
        --folder charts/${common.helm-chart-name}
        --workdir .bob --output .bob/${common.helm-chart-name}-internal
        --version ${var.version}
        --replace eric-product-info.yaml:VERSION=${var.version}
        --replace eric-product-info.yaml:REPO_PATH=${var.image-repopath-internal}
        --replace values.yaml:RSTATE=${var.rstate}

  # Push image to ci-internal repo, create internal version of helm chart and push it to internal repo
  package:
    - rule: package-local
    - task: helm-upload-internal
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env HELM_REPO_TOKEN=${env.HELM_REPO_TOKEN}"
      cmd: upload_file.sh
        --filename=.bob/${common.helm-chart-name}-internal/${common.helm-chart-name}-${var.version}.tgz
        --repository=${var.helm-chart-repo-internal}/${common.helm-chart-name}
        --api-token=${env.HELM_REPO_TOKEN}

  k8s-test:
    - rule: helm-dry-run
    - rule: create-namespace
    - rule: setup-secrets
    - rule: helm-install
    - rule: healthcheck
    - rule: networkcheck
#    - rule: helm-test
    - rule: collect-k8s-logs
    - rule: delete-namespace

  helm-dry-run:
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: helm-dry-run
      docker-image: adp-helm-kubectl
      docker-flags: &docker_flags_kube_config
        - ${env.DOCKER_NETWORK}
        - "--env HOME=${env.HOME}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env ENABLE_HELM_V3"
        - "--env HELM_VERSION"
        - "--volume ${env.PWD}:${env.PWD}"
        - "--volume ${env.HOME}:${env.HOME}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}"
        - "--volume ${var.docker-config-basepath}:${var.docker-config-basepath}"
      cmd:
        - mkdir -p ${env.COLLECT_LOGS_DIR}
        - helm install .bob/${common.helm-chart-name}-internal/${common.helm-chart-name}-${var.version}.tgz
          --set ${helm-test-values}
          --dry-run
          --debug
          --generate-name > ${env.COLLECT_LOGS_DIR}/helm-install-dry-run.log

  create-namespace:
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: create-namespace
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: kubectl create namespace ${env.K8_NAMESPACE}

  setup-secrets:
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: create-namespace-if-not-exists
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: kubectl create namespace ${env.K8_NAMESPACE} || true
    - task: setup-secrets
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: kubectl create secret generic ${image-secret}
        --from-file=.dockerconfigjson=${env.DOCKER_CONFIG}/config.json
        --type=kubernetes.io/dockerconfigjson
        --namespace ${env.K8_NAMESPACE} || true

  helm-install-dependencies:
    - rule: setup-secrets
    - task: build-dependencies
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env ENABLE_HELM_V3=true"
      cmd: helm-package
        --folder k8s-test/dependencies-chart/
        --workdir .bob --output .bob/dependencies-chart
        --version ${var.version}
    - task: helm-dry-run-dependencies
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd:
        - mkdir -p ${env.COLLECT_LOGS_DIR}
        - helm install .bob/dependencies-chart/dependencies-chart-${var.version}.tgz
          --set ${helm-test-values}
          --dry-run
          --debug
          --generate-name > ${env.COLLECT_LOGS_DIR}/dependencies-helm-install-dry-run.log
    - task: install-dependencies-on-kubernetes
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: helm install ${env.HELM_RELEASE}-dependencies .bob/dependencies-chart/dependencies-chart-${var.version}.tgz
        --namespace ${env.K8_NAMESPACE}
        --values ${env.SITE_VALUES}
        --set imageCredentials.pullSecret=${image-secret}
        --set ${helm-test-values}
        --timeout ${env.HELM_INSTALL_TIMEOUT}
        --wait
        --debug

  helm-install:
    - rule: setup-secrets
    - rule: helm-install-dependencies
    - task: install-on-kubernetes
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: helm install ${env.HELM_RELEASE} .bob/${common.helm-chart-name}-internal/${common.helm-chart-name}-${var.version}.tgz
        --namespace ${env.K8_NAMESPACE}
        --values ${env.SITE_VALUES}
        --set imageCredentials.pullSecret=${image-secret}
        --set ${helm-test-values}
        --timeout ${env.HELM_INSTALL_TIMEOUT}
        --wait
        --debug

  healthcheck:
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: healthcheck
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: ./k8s-test/scripts/healthcheck.sh

  networkcheck:
    - task: networkcheck
      docker-image: adp-helm-kubectl
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--env ENABLE_HELM_V3"
        - "--env HELM_VERSION"
        - "--env HOME=${env.HOME}"
        - "--volume ${env.HOME}:${env.HOME}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}"
      cmd:
      - chmod ug+x ./k8s-test/scripts/networkcheck.sh
      - ./k8s-test/scripts/networkcheck.sh

  helm-test:
    - rule: setup-secrets
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: install-on-kubernetes
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: helm test ${env.HELM_RELEASE}
        --namespace ${env.K8_NAMESPACE}
        --timeout ${env.HELM_TEST_TIMEOUT}

  delete-namespace:
    - task: find-docker-config-basepath
      cmd: dirname ${env.DOCKER_CONFIG} > .bob/var.docker-config-basepath
    - task: delete-releases
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd:
      - helm delete ${env.HELM_RELEASE} --namespace ${env.K8_NAMESPACE} || true
      - helm delete ${env.HELM_RELEASE}-dependencies --namespace ${env.K8_NAMESPACE} || true
    - task: delete-namespace
      docker-image: adp-helm-kubectl
      docker-flags: *docker_flags_kube_config
      cmd: kubectl delete namespace ${env.K8_NAMESPACE}

  # Publish docker images and helm charts to drop repository
  # Call publish only when merged to master
  publish:
    - task: package-helm-public
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env ENABLE_HELM_V3=true"
      cmd: helm-package
        --folder charts/${common.helm-chart-name}
        --workdir .bob --output build
        --version ${var.version}
        --replace eric-product-info.yaml:VERSION=${var.version}
        --replace eric-product-info.yaml:REPO_PATH=${var.image-repopath-drop}
        --replace values.yaml:RSTATE=${var.rstate}
    - task: image-pull-internal
      cmd:
      - docker pull ${var.image-full-name-internal}:${var.version}
      - docker pull ${var.init-image-full-name-internal}:${var.version}
    - task: image-tag-public
      cmd:
      - docker tag ${var.image-full-name-internal}:${var.version} ${image-full-name}:${var.version}
      - docker tag ${var.init-image-full-name-internal}:${var.version} ${init-image-full-name}:${var.version}
    - task: image-push-public
      cmd:
      - docker push ${image-full-name}:${var.version}
      - docker push ${init-image-full-name}:${var.version}
    - task: git-tag
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd: version-handler create-git-tag
           --tag ${var.version}
           --message "Release ${var.version}"
           --git-repo-path .
    - task: helm-upload
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env HELM_REPO_TOKEN=${env.HELM_REPO_TOKEN}"
      cmd: upload_file.sh
        --filename=build/${common.helm-chart-name}-${var.version}.tgz
        --repository=${helm-chart-drop-repo}/${common.helm-chart-name}
        --api-token=${env.HELM_REPO_TOKEN}

  poinfix-publish:
    - task: package-helm-public
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env ENABLE_HELM_V3=true"
      cmd: helm-package
        --folder charts/${common.helm-chart-name}
        --workdir .bob --output build
        --version ${var.version}
        --replace eric-product-info.yaml:VERSION=${var.version}
        --replace eric-product-info.yaml:REPO_PATH=${var.image-repopath-drop}
        --replace values.yaml:RSTATE=${var.rstate}
    - task: image-pull-internal
      cmd:
      - docker pull ${var.image-full-name-internal}:${var.version}
      - docker pull ${var.init-image-full-name-internal}:${var.version}
    - task: image-tag-public
      cmd:
      - docker tag ${var.image-full-name-internal}:${var.version} ${image-full-name}:${var.version}
      - docker tag ${var.init-image-full-name-internal}:${var.version} ${init-image-full-name}:${var.version}
    - task: image-push-public
      cmd:
      - docker push ${image-full-name}:${var.version}
      - docker push ${init-image-full-name}:${var.version}
    - task: git-tag
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd: version-handler create-git-tag
           --tag ${var.version}
           --message "Release ${var.version}"
           --git-repo-path .
    - task: helm-upload
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env HELM_REPO_TOKEN=${env.HELM_REPO_TOKEN}"
      cmd: upload_file.sh
        --filename=build/${common.helm-chart-name}-${var.version}.tgz
        --repository=${helm-chart-drop-repo}/${common.helm-chart-name}
        --api-token=${env.HELM_REPO_TOKEN}

  increment-pointfix-version-prefix:
    - task: git-push-version-prefix-increment
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd: version-handler increment
           --step-version-prefix "PATCH"
           --git-repo-path .
           --branch ${env.BRANCH}
    - task: convert-released-version
      docker-image: adp-release-auto
      cmd:
               - echo ${var.version} | sed s/-/+/ > .bob/var.released-version
    - task: adp-artifacts-properties
      docker-image: adp-release-auto
      cmd: generate-adp-artifacts
           --chart-name ${common.helm-chart-name}
           --chart-version ${var.released-version}
           --chart-repo ${helm-chart-released-repo}

  pointfix-released-version:
    - task: generate-released-version
      cmd: echo ${var.version} | sed s/-/+/ > .bob/var.released-version
    - task: helmchart-file-name
      cmd: echo ${common.helm-chart-name}-${var.released-version}.tgz > .bob/var.helmchart-file-name
    - task: generate-release-chart
      docker-image: adp-release-auto
      docker-flags:
        - --env HELM_USER
        - --env HELM_TOKEN=${env.HELM_REPO_TOKEN}
      cmd:
        - mkdir -p ${helm-chart-released-folder}
        - generate_release_helm_package
            --repo ${helm-chart-drop-repo}
            --chart-name ${common.helm-chart-name}
            --chart-version ${var.version}
            --output ${helm-chart-released-folder}
            --chart-released-version ${var.released-version}
            --helm-user ${env.HELM_USER}
            --arm-api-token ${env.HELM_REPO_TOKEN}
            --replace ${image-drop-repopath-pointfix}=${docker-image-pointfix-release-repo}
    - task: git-tag
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd: version-handler create-git-tag
           --tag ${var.released-version}
           --message "Release ${var.released-version}"
           --git-repo-path .

    - task: helm-upload
      docker-image: adp-release-auto
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env HELM_REPO_TOKEN=${env.HELM_REPO_TOKEN}"
      cmd: upload_file.sh
        --filename=${helm-chart-released-folder}/${common.helm-chart-name}-${var.released-version}.tgz
        --repository=${helm-chart-released-repo}/${common.helm-chart-name}
        --api-token=${env.HELM_REPO_TOKEN}

  collect-k8s-logs:
    - task: collect-logs-using-script
      docker-image: adp-helm-kubectl
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env ENABLE_HELM_V3"
        - "--env HELM_VERSION"
        - "--env COLLECT_LOGS_DIR"
        - "--env HOME=${env.HOME}"
        - "--volume ${env.HOME}:${env.HOME}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}"
      cmd:
        - mkdir -p ${env.COLLECT_LOGS_DIR}
        - kubectl config view > ${env.COLLECT_LOGS_DIR}/kubectl.config
        - kubectl get ns > ${env.COLLECT_LOGS_DIR}/kubectl-get-ns.log
        - helm ls -Aa > ${env.COLLECT_LOGS_DIR}/helm-ls-Aa.log
        - printenv | grep -v CREDENTIALS | grep -v ARTIFACTORY > ${env.COLLECT_LOGS_DIR}/printenv.log
        - ./k8s-test/scripts/collect_logs.sh ${env.K8_NAMESPACE} ${env.HELM_RELEASE} "/ericsson/3pp/jboss/standalone/log/server.log" ${env.COLLECT_LOGS_DIR}
        - ./k8s-test/scripts/collect_logs.sh ${env.K8_NAMESPACE} ${env.HELM_RELEASE} "/ericsson/3pp/jboss/standalone/log/messages" ${env.COLLECT_LOGS_DIR}

  # Create new Common Base OS PRA patch
  create-new-cbo-pra-patch:
    - rule: init-updatecbo
    - task: create-new-cbo-patch-pra
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd:
        # sed separator is '#' as var.cbo-image-repo string includes '/'
        - "sed -i 's#image-base-os-repo: .*#image-base-os-repo: \"${var.cbo-image-repo}\"#' common-properties.yaml"
        - "sed -i 's/image-base-os-version: .*/image-base-os-version: \"${var.cbo-image-tag}\"/' common-properties.yaml"
        # sed separator is '#' as var.cbo-package-repo-url string includes '/'
        - "sed -i 's#cbo-package-repo-url: .*#cbo-package-repo-url: \"${var.cbo-package-repo-url}\"#' common-properties.yaml"
        - gerrit create-patch -s
          --branch master
          --file common-properties.yaml
          --message "CBO PRA (version ${var.cbo-image-tag})"
          --git-repo-local .
          --wait-label "Verified"="+1"
          --debug

  # Update for Common Base OS Daily Drop
  update-new-cbo-daily-drop:
    - rule: init-updatecbo
    - task: update-common-properties
      docker-image: adp-release-auto
      cmd:
        # sed separator is '#' as var.cbo-image-repo string includes '/'
        - "sed -i 's#image-base-os-repo: .*#image-base-os-repo: \"${var.cbo-image-repo}\"#' common-properties.yaml"
        - "sed -i 's/image-base-os-version: .*/image-base-os-version: \"${var.cbo-image-tag}\"/' common-properties.yaml"
        # sed separator is '#' as var.cbo-package-repo-url string includes '/'
        - "sed -i 's#cbo-package-repo-url: .*#cbo-package-repo-url: \"${var.cbo-package-repo-url}\"#' common-properties.yaml"
    - task: create-git-commit
      cmd:
        - git config user.name "CBRSCIADM"
        - git config user.email "cbrsciadm-no-reply@nomail.com"
        - git add common-properties.yaml
        - git commit -m "CBO Daily Drop (version ${var.cbo-image-tag})"

  update-enm-iso-automatic:
    - task: get-latest-product-set
      docker-image: adp-helm-kubectl
      docker-flags:
        - ${env.DOCKER_NETWORK}
        - "--volume ${env.PWD}:${env.PWD}"
      cmd:
        - curl --location --request GET 'https://ci-portal.seli.wh.rnd.internal.ericsson.com/api/cloudNative/getGreenProductSetVersion/latest/' | sed 's/\-[0-9]*$//' > .bob/var.temp
        - bash -c 'wget -q -O - --no-check-certificate "https://ci-portal.seli.wh.rnd.internal.ericsson.com/getProductSetVersionContents/?productSet=ENM&version=${var.temp}&pretty=true" | jq -r '"'"'.[0] | .contents[] | select(.artifactName == "ERICenm_CXP9027091") | .hubUrl | capture("ERICenm_CXP9027091-(?<version>[0-9]+\\.[0-9]+\\.[0-9]+)\\.iso").version'"'" > .bob/var.iso-version
        - bash -c 'wget -q -O - --no-check-certificate "https://ci-portal.seli.wh.rnd.internal.ericsson.com/getProductSetVersionContents/?productSet=ENM&version=${var.temp}&pretty=true" | jq -r '"'"'.[0] | .contents[] | select(.artifactName == "ERICenm_CXP9027091") | .deliveredTo'"'" > .bob/var.drop-version
        - echo "${var.iso-version}" | sed 's/\./\_/g' | tee .bob/var.iso-version
    - rule: create-new-enm-iso-patch
      condition: conditions:is-new-iso-available

  update-enm-iso-manual:
    - task: update-variables
      cmd:
        - echo "${env.ENM_DROP}"  | tee .bob/var.drop-version
        - echo "${env.ENM_ISO_VERSION}"  | tee .bob/var.iso-version
        - echo "${var.iso-version}" | sed 's/\./\_/g' | tee .bob/var.iso-version
    - rule: create-new-enm-iso-patch
      condition: conditions:is-new-iso-available

  # Create new ENM ISO repo patch
  create-new-enm-iso-patch:
    - task: check-if-repo-exists
      cmd:
        - echo "ENM_${var.drop-version}_ERICenm_CXP9027091_${var.iso-version}" > .bob/var.enm-iso-repo-url
        - sed -i 's/\./_/g' .bob/var.enm-iso-repo-url
        - echo "${enm-ci-portal-repos-url}/${var.enm-iso-repo-url}" > .bob/var.enm-iso-repo-url
        - wget -q --server-response ${var.enm-iso-repo-url}/repodata/repomd.xml
        - echo "${var.iso-version}" | sed 's/\_/\./g' | tee .bob/var.iso-version
    - task: create-and-merge-new-enm-iso-patch
      docker-image: adp-release-auto
      docker-flags:
        - "--env GERRIT_USERNAME"
        - "--env GERRIT_PASSWORD"
      cmd:
        # sed separator is '#' as var.enm-iso-repo-url string includes '/'
        - "sed -i 's#enm-iso-repo-url: .*#enm-iso-repo-url: \"${var.enm-iso-repo-url}\"#' common-properties.yaml"
        - gerrit create-patch -s
          --branch master
          --file common-properties.yaml
          --message "NO-JIRA Automatically Update ENM ISO repo to ${var.iso-version}"
          --git-repo-local .
          --wait-label "Verified"="+1"
          --debug

  anchore-grype-scan:
    - task: fetch-image
      cmd: "docker pull ${image-to-scan}"
    - task: anchore-grype-scan
      docker-image: grype-scan
      docker-in-docker: socket
      cmd: grype_scan
            --image ${image-to-scan}
            --report-dir build/anchore-reports

  cleanup-trivy-anchore-images:
    - task: clean-images
      cmd:
        - "docker image rm -f ${anchore-grype-image}"
        - "docker image rm -f ${trivy-image}"
        - "docker image rm -f ${image-to-scan}"

  trivy-inline-scan:
    - task: fetch-image
      cmd:
        - "docker pull ${image-to-scan}"
        - mkdir -p build/trivy-reports
    - task: trivy-inline-scan-console-report
      docker-image: trivy-inline-scan
      docker-in-docker: socket
      cmd: --offline-scan --timeout 30m ${image-to-scan}
    - task: trivy-inline-scan-json-report
      docker-image: trivy-inline-scan
      docker-in-docker: socket
      cmd: --format json --output build/trivy-reports/trivy.report.json --offline-scan --timeout 30m ${image-to-scan}
    - task: move-trivy-property-file
      cmd: mv trivy_metadata.properties build/trivy-reports/trivy_metadata.properties

  kube-audit:
    - task: helm-template
      docker-image: adp-release-auto
      cmd: "helm template charts/${common.helm-chart-name} --set ${helm-test-values} --output-dir=.bob/helm_src"
    - task: kube-audit
      docker-image: va-scan-kubeaudit
      docker-flags:
        - "--workdir /opt/va-scan-kubeaudit/"
        - "-v ${env.PWD}/config:/opt/va-scan-kubeaudit/conf"
        - "-v ${env.PWD}/build/kube-audit-report/:/tmp/reports"
        - "-v ${env.PWD}/.bob/helm_src:/tmp/src"
      cmd: ""

  kube-sec:
    - task: helm-template
      docker-image: va-scan-kubesec
      cmd: "helm template charts/${common.helm-chart-name} --set ${helm-test-values} --output-dir=.bob/helm_kubesec"
    - task: remove-files-not-for-scanning
      cmd:
        - rm -rf .bob/helm_kubesec/${common.helm-chart-name}/templates/tests
        - rm -rf .bob/helm_kubesec/${common.helm-chart-name}/templates/hpa.yaml
        - rm -rf .bob/helm_kubesec/${common.helm-chart-name}/templates/rolebinding.yaml
    - task: kube-sec
      docker-image: va-scan-kubesec
      docker-flags:
        - "--workdir /opt/va-scan-kubesec/"
        - "-v ${env.PWD}/config:/opt/va-scan-kubesec/conf" #Place kubesec config and kube-cluster admin config here
        - "-v ${env.PWD}/build/kubesec-reports/:/tmp/reports"
        - "-v ${env.PWD}/.bob/helm_kubesec/:/tmp/src"
      cmd: ''
  generate-full-VA-report-V2:
    - task: no-upload
      docker-image: adp-release-auto
      cmd: bash -c 'va-report
           --set version=${var.version}
           --config ${env.PWD}/config/va-report.config
           --output ${env.PWD}/Vulnerability_Report_2.0.md
           --md
           --debug
           --anchore-reports ${env.PWD}/build/anchore-reports
           --trivy-reports ${env.PWD}/build/trivy-reports
           --xray-report ${env.PWD}/build/xray-reports/xray_report.json
           --raw-xray-report ${env.PWD}/build/xray-reports/raw_xray_report.json
           --hadolint-reports ${env.PWD}/build/hadolint-scan
           --kubeaudit-reports ${env.PWD}/build/kube-audit-report/${common.helm-chart-name}/templates/deployment
           --nmap-reports ${env.PWD}/nmap_reports/nmap_report/
           --ciscat-reports build/cis-cat_reports
           --kubesec-reports ${env.PWD}/build/kubesec-reports'; exit 0;
    - task: upload
      docker-image: adp-release-auto
      docker-flags:
        - --env VHUB_API_TOKEN
      cmd: bash -c 'va-report
           --set version=${var.version}
           --config ${env.PWD}/config/va-report.config
           --output ${env.PWD}/Vulnerability_Report_2.0.md
           --md
           --debug
           --anchore-reports ${env.PWD}/build/anchore-reports
           --trivy-reports ${env.PWD}/build/trivy-reports
           --hadolint-reports ${env.PWD}/build/hadolint-scan
           --xray-report ${env.PWD}/build/xray-reports/xray_report.json
           --raw-xray-report ${env.PWD}/build/xray-reports/raw_xray_report.json
           --kubeaudit-reports ${env.PWD}/build/kube-audit-report/${common.helm-chart-name}/templates/deployment
           --kubesec-reports ${env.PWD}/build/kubesec-reports
           --nmap-reports ${env.PWD}/nmap_reports/nmap_report/
           --upload-scan-results'; exit 0;

  generate-VA-report-V2:
    - task: no-upload
      docker-image: adp-release-auto
      cmd: bash -c 'va-report
           --set version=${var.version}
           --config ${env.PWD}/config/va-report.config
           --output ${env.PWD}/Vulnerability_Report_2.0.md
           --md
           --debug
           --anchore-reports ${env.PWD}/build/anchore-reports
           --trivy-reports ${env.PWD}/build/trivy-reports
           --xray-report ${env.PWD}/build/xray-reports/xray_report.json
           --raw-xray-report ${env.PWD}/build/xray-reports/raw_xray_report.json
           --hadolint-reports ${env.PWD}/build/hadolint-scan
           --kubeaudit-reports ${env.PWD}/build/kube-audit-report/${common.helm-chart-name}/templates/deployment
           --kubesec-reports ${env.PWD}/build/kubesec-reports'; exit 0;
    - task: upload
      docker-image: adp-release-auto
      docker-flags:
        - --env VHUB_API_TOKEN
      cmd: bash -c 'va-report
           --set version=${var.version}
           --config ${env.PWD}/config/va-report.config
           --output ${env.PWD}/Vulnerability_Report_2.0.md
           --md
           --debug
           --anchore-reports ${env.PWD}/build/anchore-reports
           --trivy-reports ${env.PWD}/build/trivy-reports
           --hadolint-reports ${env.PWD}/build/hadolint-scan
           --xray-report ${env.PWD}/build/xray-reports/xray_report.json
           --raw-xray-report ${env.PWD}/build/xray-reports/raw_xray_report.json
           --kubeaudit-reports ${env.PWD}/build/kube-audit-report/${common.helm-chart-name}/templates/deployment
           --kubesec-reports ${env.PWD}/build/kubesec-reports
           --upload-scan-results'; exit 0;
  kube-hunter:
    - task: kube-hunter
      docker-image: va-scan-kubehunter
      docker-flags:
        - "--workdir /opt/kubehunter/"
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "-v ${env.PWD}/config:/opt/kubehunter/conf" #Place kubesec config here
        - "-v ${env.PWD}/build/kubehunter-report/:/tmp/reports"
      cmd: " "
  hadolint-scan:
    - task: hadolint-scan-test
      docker-image: hadolint-scan
      docker-flags:
        - "--workdir /app/"
        - "-v ${env.PWD}/config/hadolint_config.yaml:/config/hadolint_config.yaml"
        - "-v ${env.PWD}/docker:/Dockerfile"
        - "-v ${env.PWD}/build/hadolint-scan:/tmp/reports/"
      cmd: "-p ${common.helm-chart-name} -d /Dockerfile/${common.init-docker-image-name} /Dockerfile/${common.docker-image-name} -c /config/hadolint_config.yaml "
  fetch-xray-report:
    - task: fetch-xray-report
      docker-image: adp-release-auto
      cmd: bash -c 'fetch-xray
          --config ${env.PWD}/config/xray_report.config
          --debug
          --user ${env.XRAY_USER}
          --apikey ${env.XRAY_TOKEN}
          --output ${env.PWD}/build/xray-reports/xray_report.json
          --set version=${var.version}
          --raw-output ${env.PWD}/build/xray-reports/raw_xray_report.json'

  clean-report:
    - task: clean
      cmd: rm -rf ${env.PWD}/${build-dir} .bob ${env.PWD}/user-guide-template/.bob

  # Initialize, generate version and read commit hash
  init-report:
    - task: bob-dir
      cmd: mkdir -p .bob
    - task: user-guide-version
      docker-image: adp-release-auto
      cmd: ${env.PWD}/utils/generate-doc-version
           --is-release ${env.RELEASE}
          --source ${env.PWD}/user-guide-template
          --output user-guide-version
          -f ${env.PWD}/user-guide-template/VERSION_PREFIX
    - task: date
      docker-image: adp-release-auto
      cmd: generate-date --output date
    - task: propagate-bob-vars
      cmd: cp -r .bob ${env.PWD}/user-guide-template/.bob
    - task: tmpdir
      cmd: mkdir -p ${env.PWD}/${build-dir}

  # Run link to check MD files
  lint-report:
    - task: markdownlint
      docker-image: doc-builder
      cmd: markdownlint --config ./markdownlint.yaml $(git ls-files -- \*\.md | grep -v vendor | cat | xargs)

  generate-docs:
    - task: generate-user-guide-html
      docker-image: adp-release-auto
      cmd: doc-handler generate
           --config ${config-file}
           --output ${build-dir}/${html-output}
           --format html

    - task: generate-user-guide-pdf
      docker-image: adp-release-auto
      cmd: doc-handler generate
           --config ${config-file}
           --output ${build-dir}/${pdf-output}
           --format pdf
           --stylesheet /usr/share/marketplace/resources/pdf_style.css

  kube-bench:
    - task: kube-scan-test
      docker-image: va-scan-kubebench
      docker-flags:
        - "--workdir /opt/kubebench/"
        - "--env KUBECONFIG=${env.KUBECONFIG}"   # Export the KUBECONFIG environment variable else it will look for kubeconfig file under home directory.
        - "--env STD_TIMEOUT=${env.STD_TIMEOUT}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "-v ${env.PWD}/config:/opt/kubebench/conf" #Place kube-bench config file
        - "-v ${env.PWD}/build/kubebench-report/:/tmp/reports"
      cmd: " "

  get-pods:
    - task: get-pods
      docker-image: adp-helm-kubectl
      docker-flags:
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "--volume ${env.PWD}:${env.PWD}"
      cmd: kubectl get pods -o name -n ${env.K8_NAMESPACE} --field-selector=status.phase=Running | grep  eric-cbrs-dc |sed -e 's#pod/##g' > .bob/var.pods

  nmap-port-scanning:
    - task: nmap-port-scanning-test
      docker-image: adp-helm-kubectl
      docker-flags:
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "--volume ${env.PWD}:${env.PWD}"
      cmd: /test.py --kubernetes-admin-conf=${env.KUBECONFIG}
           --helm-user=${env.SERO_USER}
           --arm-api-token=${env.SERO_PASSWORD}
           --kubernetes-namespace=${env.K8_NAMESPACE}
           --nmap-config-file=nmap_config.yaml
           --nmap-test
  #enable cleanup rule for unicorn scan also if we enabled it
  nmap-cleanup:
    - task: nmap-cleanup
      docker-image: adp-helm-kubectl
      docker-flags:
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "--volume ${env.PWD}:${env.PWD}"
      cmd: /usr/share/helm/v3.8.1/helm uninstall nmap-${env.K8_NAMESPACE} -n ${env.K8_NAMESPACE} --wait|true
    - task: unicorn-cleanup
      condition: unicorn-release-exists:condition-true
      docker-image: adp-helm-kubectl
      docker-flags:
        - "--env KUBECONFIG=${env.KUBECONFIG}"
        - "--env K8_NAMESPACE=${env.K8_NAMESPACE}"
        - "--volume ${env.KUBECONFIG}:${env.KUBECONFIG}:ro"
        - "--volume ${env.PWD}:${env.PWD}"
      cmd: /usr/share/helm/v3.8.1/helm uninstall unicorn-${env.K8_NAMESPACE} -n ${env.K8_NAMESPACE} --wait|true

  cis-cat-assessor-scan:
    - task: create-report-directory
      cmd: mkdir -p build/cis-cat_reports
    - task: build-target-image-for-ciscat-scan
      cmd: docker build ${env.PWD}/config/cis_cat_assessor/docker
           --tag ${ciscat-test-target-image-name}:${var.version}
           --build-arg TARGET_IMAGE=${var.image-full-name-internal}
           --build-arg TARGET_IMAGE_VERSION=${var.version}
    #Scan the eric-cbrs-dc main container
    - task: execute-cis-cat-scanner
      docker-image: adp-ciscat-scanner
      docker-in-docker: socket
      docker-flags:
        - "--volume ${env.VA_HOME}/.docker:/root/.docker"
        - "--env HOST_CIS_CAT_WS=${env.PWD}"
        - "--volume ${env.PWD}:${env.PWD}"
        - "--volume /var/run/docker.sock:/var/run/docker.sock"
        - "--workdir ${env.PWD}"
      cmd: cis-cat-assessor-scan
           --target-image ${ciscat-test-target-image-name}:${var.version}
           --benchmark CIS_SUSE_Linux_Enterprise_15_Benchmark_v1.1.1-xccdf.xml 'Level 2 - Server'
           --report-dir cis-cat_reports
           --report-name-prefix cis-cat-report
           --debug
           --applicability-spec config/cis_cat_assessor/cis_suse_linux_enterprise_15_benchmark_applicability_specification.json
    - task: copy-enriched-ciscat-reports
      cmd: cp -a ${env.PWD}/cis_cat_assessor/cis-cat_reports/*_enriched.json build/cis-cat_reports/
